<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geovisor de Predios</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .container {
            display: flex;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }
        
        .sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }
        
        .map-container {
            flex: 1;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            color: #666;
            font-size: 14px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .filters {
            margin-bottom: 20px;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .filter-group input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .property-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }
        
        .property-info h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .property-info div {
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .property-info strong {
            color: #667eea;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 10px;
        }
        
        .leaflet-popup-content {
            margin: 10px 15px;
            line-height: 1.4;
        }
        
        .popup-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .popup-field {
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .popup-field strong {
            color: #667eea;
        }
        
        .zoom-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .location-status {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .location-status.loading {
            color: #667eea;
        }
        
        .location-status.success {
            color: #28a745;
        }
        
        .location-status.error {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="header">
                <h1>üèòÔ∏è Geovisor de Predios</h1>
                <p>Visualizaci√≥n de predios catastrales</p>
            </div>
            
            <div id="locationStatus" class="location-status">
                üìç Inicializando mapa...
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <h3 id="totalPredios">0</h3>
                    <p>Total Predios</p>
                </div>
                <div class="stat-card">
                    <h3 id="prediosVisible">0</h3>
                    <p>Visibles</p>
                </div>
            </div>
            
            <div class="filters">
                <div class="filter-group">
                    <label for="searchId">Buscar por ID Predio:</label>
                    <input type="text" id="searchId" placeholder="Ingrese ID del predio">
                </div>
                
                <button class="btn" onclick="aplicarFiltros()">üîç Buscar</button>
                <button class="btn" onclick="limpiarFiltros()">üóëÔ∏è Limpiar</button>
                <button class="btn" onclick="exportarDatos()">üìä Exportar Datos</button>
            </div>
            
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Cargando datos...</p>
            </div>
            
            <div id="propertyInfo" class="property-info" style="display: none;">
                <h3>Informaci√≥n del Predio</h3>
                <div id="propertyDetails"></div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="mapLoading" class="map-loading" style="display: none;">
                <div class="spinner"></div>
                <p>Cargando predios...</p>
            </div>
            <div class="zoom-info">
                <div>Zoom: <span id="currentZoom">10</span></div>
                <div>Predios: <span id="currentPredios">0</span></div>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Configuraci√≥n de la base de datos
        const SUPABASE_URL = 'https://dpxlpyyelqbwudkhdtbw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRweGxweXllbHFid3Vka2hkdGJ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxMjMwNjksImV4cCI6MjA2NTY5OTA2OX0.j8evYP_owzPeJmZ5GgdHnjpg1dYE4DShcI9fYYA8xG8';
        
        // Coordenadas de El Pangui, Zamora Chinchipe
        const EL_PANGUI_COORDS = [-3.6167, -78.55];
        
        // Variables globales
        let map;
        let prediosLayer;
        let currentData = [];
        let allData = [];
        let isLoading = false;
        let currentZoom = 10;
        let loadTimeout;
        
        // Configuraci√≥n de l√≠mites por zoom
        const ZOOM_LIMITS = {
            8: 50,   // Zoom bajo: pocos predios
            10: 100,  // Zoom medio: m√°s predios
            12: 250,  // Zoom alto: muchos predios
            14: 500,  // Zoom muy alto: m√°ximo predios
            16: 1000  // Zoom m√°ximo: todos los predios visibles
        };
        
        // Inicializar mapa
        function initMap() {
            updateLocationStatus('Inicializando mapa centrado en El Pangui...', 'loading');
            
            // Crear mapa centrado en El Pangui
            map = L.map('map').setView(EL_PANGUI_COORDS, 10);
            
            // A√±adir capa base
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // A√±adir capa de sat√©lite como opci√≥n
            const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Esri, DigitalGlobe, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community'
            });
            
            // Control de capas
            const baseMaps = {
                "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
                "Sat√©lite": satellite
            };
            
            L.control.layers(baseMaps).addTo(map);
            
            // Crear grupo de capas para predios
            prediosLayer = L.layerGroup().addTo(map);
            
            // Eventos del mapa
            map.on('zoomend', onMapChange);
            map.on('moveend', onMapChange);
            
            // Actualizar zoom inicial
            currentZoom = map.getZoom();
            document.getElementById('currentZoom').textContent = currentZoom;
            
            updateLocationStatus('Mapa centrado en El Pangui - Listo para cargar datos', 'success');
        }
        
        // Funci√≥n que se ejecuta cuando cambia el mapa
        function onMapChange() {
            const newZoom = map.getZoom();
            const zoomChanged = newZoom !== currentZoom;
            currentZoom = newZoom;
            document.getElementById('currentZoom').textContent = currentZoom;
            
            // Cancelar carga anterior si existe
            if (loadTimeout) {
                clearTimeout(loadTimeout);
            }
            
            // Cargar datos con delay para evitar m√∫ltiples cargas
            loadTimeout = setTimeout(() => {
                cargarDatosPorZoom(zoomChanged);
            }, 500);
        }
        
        // Funci√≥n para cargar datos seg√∫n el zoom
        async function cargarDatosPorZoom(zoomChanged = false) {
            if (isLoading) return;
            
            const limit = getLimitForZoom(currentZoom);
            const bounds = map.getBounds();
            
            // Solo recargar si cambi√≥ el zoom significativamente o si es la primera carga
            if (zoomChanged || prediosLayer.getLayers().length === 0) {
                await cargarDatos({}, limit, bounds);
            }
        }
        
        // Obtener l√≠mite de predios seg√∫n zoom
        function getLimitForZoom(zoom) {
            if (zoom <= 8) return ZOOM_LIMITS[8];
            if (zoom <= 10) return ZOOM_LIMITS[10];
            if (zoom <= 12) return ZOOM_LIMITS[12];
            if (zoom <= 14) return ZOOM_LIMITS[14];
            return ZOOM_LIMITS[16];
        }
        
        // Funci√≥n para cargar datos de Supabase
        async function cargarDatos(filtros = {}, limit = null, bounds = null) {
            if (isLoading) return;
            
            isLoading = true;
            mostrarMapLoading(true);
            
            try {
                // Usar el nombre correcto de la tabla
                let query = `${SUPABASE_URL}/rest/v1/Predios_4326?select=*`;
                
                // Aplicar filtros (solo b√∫squeda por ID ahora)
                const conditions = [];
                if (filtros.id_pred) conditions.push(`ID_PRED.ilike.%${filtros.id_pred}%`);
                
                // Filtro por √°rea visible (bounds) si est√° disponible
                if (bounds && !filtros.id_pred) {
                    // Nota: Este filtro espacial podr√≠a necesitar ajustes seg√∫n la estructura de datos
                    // conditions.push(`geom.intersects.${bounds}`);
                }
                
                if (conditions.length > 0) {
                    query += `&${conditions.join('&')}`;
                }
                
                // Aplicar l√≠mite basado en zoom
                const finalLimit = limit || getLimitForZoom(currentZoom);
                query += `&limit=${finalLimit}`;
                
                // Ordenar por √°rea para mostrar primero los predios m√°s grandes
                query += '&order=Shape_Area.desc';
                
                console.log('Query URL:', query);
                console.log('L√≠mite para zoom', currentZoom, ':', finalLimit);
                
                const response = await fetch(query, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error ${response.status}: ${response.statusText}\n${errorText}`);
                }
                
                const data = await response.json();
                console.log('Datos recibidos:', data.length, 'registros');
                
                currentData = data;
                
                // Actualizar estad√≠sticas
                document.getElementById('totalPredios').textContent = data.length;
                document.getElementById('prediosVisible').textContent = data.length;
                document.getElementById('currentPredios').textContent = data.length;
                
                // Cargar datos en el mapa
                cargarPrediosEnMapa(data);
                
                updateLocationStatus(`Cargados ${data.length} predios (zoom ${currentZoom})`, 'success');
                
            } catch (error) {
                console.error('Error completo:', error);
                updateLocationStatus(`Error al cargar datos: ${error.message}`, 'error');
            } finally {
                isLoading = false;
                mostrarMapLoading(false);
            }
        }
        
        // Funci√≥n para cargar predios en el mapa
        function cargarPrediosEnMapa(data) {
            // Limpiar capa anterior
            prediosLayer.clearLayers();
            
            if (data.length === 0) {
                updateLocationStatus('No se encontraron predios en esta √°rea', 'error');
                return;
            }
            
            let addedCount = 0;
            
            // Crear marcadores o pol√≠gonos seg√∫n el tipo de geometr√≠a
            data.forEach(predio => {
                if (predio.geom) {
                    try {
                        const geom = typeof predio.geom === 'string' ? JSON.parse(predio.geom) : predio.geom;
                        
                        if (geom.type === 'Point') {
                            const marker = L.marker([geom.coordinates[1], geom.coordinates[0]]);
                            marker.bindPopup(crearPopupContent(predio));
                            prediosLayer.addLayer(marker);
                            addedCount++;
                        } else if (geom.type === 'Polygon' || geom.type === 'MultiPolygon') {
                            const polygon = L.geoJSON(geom, {
                                style: {
                                    color: getColorByType(predio.TIPO_PRED),
                                    weight: 2,
                                    opacity: 0.8,
                                    fillOpacity: 0.3
                                }
                            });
                            polygon.bindPopup(crearPopupContent(predio));
                            prediosLayer.addLayer(polygon);
                            addedCount++;
                        }
                    } catch (error) {
                        console.error('Error al procesar geometr√≠a:', error);
                    }
                }
            });
            
            console.log(`Agregados ${addedCount} predios al mapa`);
            
            // Solo ajustar vista si es la primera carga o si hay filtros espec√≠ficos
            if (addedCount > 0 && (prediosLayer.getLayers().length <= 50 || Object.keys(getFiltrosActivos()).length > 0)) {
                try {
                    const group = new L.featureGroup(prediosLayer.getLayers());
                    map.fitBounds(group.getBounds(), { padding: [10, 10] });
                } catch (error) {
                    console.error('Error al ajustar vista:', error);
                }
            }
        }
        
        // Obtener color seg√∫n tipo de predio
        function getColorByType(tipo) {
            const colors = {
                'URBANO': '#FF6B6B',
                'RURAL': '#4ECDC4',
                'INDUSTRIAL': '#45B7D1',
                'COMERCIAL': '#FFA07A',
                'RESIDENCIAL': '#98D8C8'
            };
            return colors[tipo] || '#667eea';
        }
        
        // Crear contenido del popup
        function crearPopupContent(predio) {
            return `
                <div class="popup-title">Predio: ${predio.ID_PRED || 'N/A'}</div>
                <div class="popup-field"><strong>Tipo:</strong> ${predio.TIPO_PRED || 'N/A'}</div>
                <div class="popup-field"><strong>Uso:</strong> ${predio.USO_PRED || 'N/A'}</div>
                <div class="popup-field"><strong>√Årea:</strong> ${predio.Shape_Area ? predio.Shape_Area.toFixed(2) + ' m¬≤' : 'N/A'}</div>
                <div class="popup-field"><strong>Provincia:</strong> ${predio.DESPROV || 'N/A'}</div>
                <div class="popup-field"><strong>Cant√≥n:</strong> ${predio.DESCAN || 'N/A'}</div>
                <div class="popup-field"><strong>Aval√∫o Total:</strong> ${predio.AVALUO_TOT ? '$' + predio.AVALUO_TOT.toFixed(2) : 'N/A'}</div>
            `;
        }
        
        // Obtener filtros activos
        function getFiltrosActivos() {
            const filtros = {
                id_pred: document.getElementById('searchId').value
            };
            
            // Remover filtros vac√≠os
            Object.keys(filtros).forEach(key => {
                if (!filtros[key]) delete filtros[key];
            });
            
            return filtros;
        }
        
        // Aplicar filtros
        function aplicarFiltros() {
            const filtros = getFiltrosActivos();
            cargarDatos(filtros, 500); // M√°s predios cuando se aplican filtros
        }
        
        // Limpiar filtros
        function limpiarFiltros() {
            document.getElementById('searchId').value = '';
            cargarDatosPorZoom(true);
        }
        
        // Exportar datos
        function exportarDatos() {
            if (currentData.length === 0) {
                alert('No hay datos para exportar.');
                return;
            }
            
            // Crear CSV
            const headers = ['ID_PRED', 'TIPO_PRED', 'USO_PRED', 'Shape_Area', 'DESPROV', 'DESCAN', 'AVALUO_TOT'];
            const csvContent = [
                headers.join(','),
                ...currentData.map(row => headers.map(header => row[header] || '').join(','))
            ].join('\n');
            
            // Descargar archivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `predios_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        // Actualizar estado de ubicaci√≥n
        function updateLocationStatus(message, type) {
            const statusEl = document.getElementById('locationStatus');
            statusEl.textContent = message;
            statusEl.className = `location-status ${type}`;
        }
        
        // Mostrar/ocultar loading del mapa
        function mostrarMapLoading(show) {
            document.getElementById('mapLoading').style.display = show ? 'block' : 'none';
        }
        
        // Mostrar/ocultar loading del sidebar
        function mostrarLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // Funci√≥n para probar la conexi√≥n
        async function testConnection() {
            try {
                updateLocationStatus('Probando conexi√≥n con base de datos...', 'loading');
                
                // Probar consulta simple sin filtros
                const response = await fetch(`${SUPABASE_URL}/rest/v1/Predios_4326?select=id&limit=1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Conexi√≥n exitosa:', data);
                    updateLocationStatus('Conexi√≥n exitosa - Cargando datos iniciales...', 'success');
                    
                    // Cargar datos iniciales
                    setTimeout(() => {
                        cargarDatosPorZoom(true);
                    }, 1000);
                } else {
                    const errorText = await response.text();
                    console.error('Error de conexi√≥n:', errorText);
                    updateLocationStatus(`Error de conexi√≥n: ${response.status}`, 'error');
                }
                
            } catch (error) {
                console.error('Error en test:', error);
                updateLocationStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        // Inicializar aplicaci√≥n
        window.onload = function() {
            console.log('Inicializando aplicaci√≥n...');
            console.log('Coordenadas El Pangui:', EL_PANGUI_COORDS);
            
            // Inicializar mapa
            initMap();
            
            // Probar conexi√≥n despu√©s de un peque√±o delay
            setTimeout(() => {
                testConnection();
            }, 500);
        };
        
        // Funci√≥n adicional para centrar en El Pangui
        function centrarEnElPangui() {
            map.setView(EL_PANGUI_COORDS, 13);
            updateLocationStatus('Centrado en El Pangui', 'success');
        }
        
        // Funci√≥n para mostrar informaci√≥n del √°rea actual
        function mostrarInfoArea() {
            const bounds = map.getBounds();
            const center = map.getCenter();
            const zoom = map.getZoom();
            
            console.log('Informaci√≥n del √°rea actual:');
            console.log('Centro:', center);
            console.log('Zoom:', zoom);
            console.log('Bounds:', bounds);
            console.log('L√≠mite de predios para este zoom:', getLimitForZoom(zoom));
        }
        
        // Agregar evento de teclado para funciones de debug
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                mostrarInfoArea();
            }
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                centrarEnElPangui();
            }
        });
    </script>
</body>
</html>
